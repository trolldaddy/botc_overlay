<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>BOTC Overlay</title>
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
</head>
<body>
  <div id="container"></div>
  <script>
    async function loadRoles(scriptFileName) {
      try {
        const [customList, referenceList] = await Promise.all([
          fetch(`/Allscript/${scriptFileName}`).then(r => r.json()),
          fetch(`/EVERY_SINGLE_ROLE_with_chinese_abilities.json`).then(r => r.json())
        ]);

        const referenceMap = Object.fromEntries(referenceList.map(r => [r.id, r]));

        const container = document.getElementById('container');
        container.innerHTML = '';

        customList.forEach(role => {
          const ref = referenceMap[role.id];
          if (!ref) return;

          const div = document.createElement('div');
          div.textContent = `${ref.name_zh || ref.name || role.id} - ${ref.ability || ''}`;
          container.appendChild(div);
        });
      } catch (err) {
        console.error('載入角色失敗', err);
      }
    }

    if (window.Twitch && window.Twitch.ext) {
      window.Twitch.ext.onAuthorized(auth => {
        window.Twitch.ext.configuration.onChanged(() => {
          try {
            const config = JSON.parse(window.Twitch.ext.configuration.broadcaster.content);
            if (config.selectedScript) {
              loadRoles(config.selectedScript);
            } else {
              loadRoles('custom-list.json');
            }
          } catch (e) {
            loadRoles('custom-list.json');
          }
        });
      });
    } else {
      loadRoles('custom-list.json');
    }
  </script>
</body>
</html>
