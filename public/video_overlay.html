<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOTC Overlay</title>
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: rgba(0, 0, 0, 0.9);
      color: white;
    }
    #toggleButton, #refreshButton {
      position: fixed;
      bottom: 20px;
      background: black;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 9999;
    }
    #toggleButton {
      left: 40%;
      transform: translateX(-50%);
    }
    #refreshButton {
      left: 60%;
      transform: translateX(-50%);
    }
    .panel {
      position: fixed;
      top: 5rem;
      bottom: 0;
      width: 50%;
      background: rgba(0, 0, 0, 0.9);
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    #leftPanel {
      left: 0;
      transform: translateX(-100%);
    }
    #rightPanel {
      right: 0;
      transform: translateX(100%);
    }
    .panel.open {
      transform: translateX(0);
    }
    .category-title {
      font-size: 1.25rem;
      font-weight: bold;
      border-bottom: 1px solid white;
      padding: 0.5rem;
    }
    .role-grid {
      display: flex;
      flex-wrap: wrap;
      padding: 0.5rem;
    }
    .role-entry {
      width: 100px;
      margin: 10px;
      text-align: center;
      position: relative;
    }
    .role-entry img {
      width: 65px;
      height: 65px;
    }
    .tooltip {
      position: absolute;
      max-width: 300px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      white-space: normal;
      display: none;
      z-index: 99999;
    }
  </style>
</head>
<body>
  <button id="toggleButton">顯示角色中文</button>
  <button id="refreshButton">重新載入</button>
  <div id="leftPanel" class="panel"></div>
  <div id="rightPanel" class="panel"></div>
  <div id="globalTooltip" class="tooltip"></div>

  <script>
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const toggleButton = document.getElementById('toggleButton');
    const refreshButton = document.getElementById('refreshButton');
    const globalTooltip = document.getElementById('globalTooltip');
    let panelsVisible = false;

    toggleButton.addEventListener('click', () => {
      panelsVisible = !panelsVisible;
      if (panelsVisible) {
        leftPanel.classList.add('open');
        rightPanel.classList.add('open');
      } else {
        leftPanel.classList.remove('open');
        rightPanel.classList.remove('open');
      }
    });

    refreshButton.addEventListener('click', () => {
      handleConfigChange();
    });

    function loadRolesFromList(customList) {
      leftPanel.innerHTML = '<div class="category-title">鎮民</div><div class="role-grid" id="townsfolkGrid"></div>';
      rightPanel.innerHTML = '<div class="category-title">外來者</div><div class="role-grid" id="outsiderGrid"></div>' +
                             '<div class="category-title">爪牙</div><div class="role-grid" id="minionGrid"></div>' +
                             '<div class="category-title">惡魔</div><div class="role-grid" id="demonGrid"></div>';

      fetch('https://botc-twitch-873087277461.asia-east1.run.app/EVERY_SINGLE_ROLE_with_image_placeholders.json')
        .then(res => res.json())
        .then(referenceList => {
          const referenceMap = Object.fromEntries(referenceList.map(r => [r.id, r]));
          customList.forEach(role => {
            const roleData = referenceMap[role.id];
            if (!roleData) return;
            const container = document.createElement('div');
            container.className = 'role-entry';

            const img = document.createElement('img');
            img.src = roleData.image;
            img.alt = roleData.name_zh || roleData.name || role.id;

            const label = document.createElement('div');
            label.textContent = roleData.name_zh || roleData.name || role.id;

            container.appendChild(img);
            container.appendChild(label);

            container.addEventListener('mouseenter', e => {
              globalTooltip.textContent = roleData.ability_zh || roleData.ability || '';
              globalTooltip.style.display = 'block';
              const rect = container.getBoundingClientRect();
              const isRight = window.innerWidth / 2 < rect.left;
              const left = isRight
                ? Math.max(0, rect.left - globalTooltip.offsetWidth - 10)
                : Math.min(window.innerWidth - globalTooltip.offsetWidth, rect.right + 10);
              globalTooltip.style.left = `${left}px`;
              globalTooltip.style.top = `${rect.top + window.scrollY}px`;
            });

            container.addEventListener('mouseleave', () => {
              globalTooltip.style.display = 'none';
            });

            if (roleData.team === '鎮民') {
              document.getElementById('townsfolkGrid').appendChild(container);
            } else if (roleData.team === '外來者') {
              document.getElementById('outsiderGrid').appendChild(container);
            } else if (roleData.team === '爪牙') {
              document.getElementById('minionGrid').appendChild(container);
            } else if (roleData.team === '惡魔') {
              document.getElementById('demonGrid').appendChild(container);
            }
          });
        });
    }

    function handleConfigChange() {
      const configStr = window.Twitch.ext.configuration.broadcaster?.content;
      if (!configStr) return;
      try {
        const config = JSON.parse(configStr);
        if (config.selectedScript === '__custom__' && config.customJson) {
          const customList = JSON.parse(config.customJson);
          loadRolesFromList(customList);
        } else if (config.selectedScript) {
          fetch(`/Allscript/${config.selectedScript}`)
            .then(r => r.json())
            .then(loadRolesFromList)
            .catch(() => fetch('/Allscript/trouble-brewing.json').then(r => r.json()).then(loadRolesFromList));
        } else {
          fetch('/Allscript/trouble-brewing.json').then(r => r.json()).then(loadRolesFromList);
        }
      } catch (e) {
        console.error('解析設定錯誤:', e);
        fetch('/Allscript/trouble-brewing.json').then(r => r.json()).then(loadRolesFromList);
      }
    }

    if (window.Twitch && window.Twitch.ext) {
      window.Twitch.ext.onAuthorized(() => {
        handleConfigChange();
        window.Twitch.ext.configuration.onChanged(() => {
          handleConfigChange();
        });
      });
    } else {
      fetch('/Allscript/trouble-brewing.json').then(r => r.json()).then(loadRolesFromList);
    }
  </script>
</body>
</html>
