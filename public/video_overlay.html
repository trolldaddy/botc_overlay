<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>BOTC 角色總覽</title>
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
  <style>
    body { margin: 0; background: transparent; font-family: Arial, sans-serif; }
    #toggleButton {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #000; color: #fff; padding: 10px 20px; border: none; border-radius: 5px;
      z-index: 1001;
    }
    .panel {
      position: fixed; top: 0; bottom: 0; width: 300px; background: rgba(0,0,0,0.85);
      overflow-y: auto; padding: 10px; transform: translateX(-100%);
      transition: transform 0.3s ease; color: #fff;
    }
    .panel.right { right: 0; left: auto; transform: translateX(100%); }
    .panel.show { transform: translateX(0); }
    .category-title { font-size: 1.2em; margin-top: 10px; border-bottom: 1px solid #fff; padding-bottom: 5px; }
    .role {
      display: inline-block; width: 50px; text-align: center; margin: 5px; position: relative;
    }
    .role img { width: 50px; height: 50px; display: block; }
    .tooltip {
      visibility: hidden; background: rgba(0, 0, 0, 0.75); color: #fff; border-radius: 5px;
      padding: 5px; position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
      white-space: nowrap; z-index: 1002;
    }
    .role:hover .tooltip { visibility: visible; }
  </style>
</head>

<body>
  <button id="toggleButton">顯示角色</button>
  <div id="leftPanel" class="panel"></div>
  <div id="rightPanel" class="panel right"></div>

  <script>
    const toggleButton = document.getElementById('toggleButton');
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');

    let isVisible = false;
    toggleButton.addEventListener('click', () => {
      isVisible = !isVisible;
      leftPanel.classList.toggle('show', isVisible);
      rightPanel.classList.toggle('show', isVisible);
    });

    async function loadRoles() {
      try {
        const customList = await fetch('custom-list.json').then(r => r.json());
        const referenceList = await fetch('role_reference_trouble_brewing.json').then(r => r.json());

        const referenceMap = Object.fromEntries(referenceList.map(r => [r.id, r]));

        const categories = {
          '鎮民': [],
          '外來者': [],
          '爪牙': [],
          '惡魔': []
        };

        customList.forEach(role => {
          const ref = referenceMap[role.id];
          if (!ref) return;
          const displayName = ref.name_zh || ref.name || role.id;
          const imgUrl = ref.image || '';
          const ability = ref.ability || '';

          const roleHtml = `
            <div class="role">
              <img src="${imgUrl}" alt="${displayName}">
              <div>${displayName}</div>
              <div class="tooltip">${ability}</div>
            </div>
          `;

          if (categories[ref.type]) {
            categories[ref.type].push(roleHtml);
          }
        });

        leftPanel.innerHTML = `<div class="category-title">鎮民</div>${categories['鎮民'].join('')}`;
        rightPanel.innerHTML = `
          <div class="category-title">外來者</div>${categories['外來者'].join('')}
          <div class="category-title">爪牙</div>${categories['爪牙'].join('')}
          <div class="category-title">惡魔</div>${categories['惡魔'].join('')}
        `;

      } catch (err) {
        console.error('載入角色資料失敗:', err);
      }
    }

    if (window.Twitch && window.Twitch.ext) {
      window.Twitch.ext.onAuthorized(auth => {
        console.log('Twitch Extension Authorized', auth);
        loadRoles();
      });
    } else {
      console.log('Twitch Extension 未載入或未授權，直接載入角色');
      loadRoles();
    }
  </script>
</body>

</html>
