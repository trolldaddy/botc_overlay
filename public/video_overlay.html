<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>BOTC Overlay</title>
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #111;
      font-family: "Microsoft JhengHei", sans-serif;
      color: white;
    }
    #leftPanel, #rightPanel {
      position: fixed;
      top: 5rem;
      width: 50%;
      height: calc(100vh - 5rem);
      overflow-y: auto;
      padding: 1rem;
      box-sizing: border-box;
      transition: transform 0.3s ease;
    }
    #leftPanel { left: 0; background-color: #222; transform: translateX(-100%); }
    #rightPanel { right: 0; background-color: #222; transform: translateX(100%); }
    .panel-open #leftPanel { transform: translateX(0); }
    .panel-open #rightPanel { transform: translateX(0); }
    .category-title {
      font-size: 1.5rem;
      font-weight: bold;
      border-bottom: 2px solid #fff;
      margin-bottom: 0.5rem;
    }
    .role-grid {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .role-entry {
      text-align: center;
      position: relative;
    }
    .role-entry img {
      width: 65px;
      height: 65px;
    }
    .tooltip {
      position: fixed;
      display: none;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      max-width: 300px;
      white-space: normal;
      z-index: 9999;
    }
    #toggleButton {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <button id="toggleButton">顯示/隱藏角色</button>

  <div id="leftPanel">
    <div class="category-title">鎮民</div>
    <div class="role-grid" id="townsfolkGrid"></div>
  </div>
  <div id="rightPanel">
    <div class="category-title">外來者</div>
    <div class="role-grid" id="outsiderGrid"></div>
    <div class="category-title">爪牙</div>
    <div class="role-grid" id="minionGrid"></div>
    <div class="category-title">惡魔</div>
    <div class="role-grid" id="demonGrid"></div>
  </div>
  <div id="globalTooltip" class="tooltip"></div>
  <script>
    const globalTooltip = document.getElementById('globalTooltip');
    const body = document.body;
    const toggleButton = document.getElementById('toggleButton');
    toggleButton.addEventListener('click', () => {
      body.classList.toggle('panel-open');
    });

    function createRoleElement(role, ability, image, team) {
      const container = document.createElement('div');
      container.className = 'role-entry';

      const img = document.createElement('img');
      img.src = image;
      img.alt = role;

      const label = document.createElement('div');
      label.textContent = role;

      container.appendChild(img);
      container.appendChild(label);

      container.addEventListener('mouseenter', () => {
        globalTooltip.textContent = ability;
        globalTooltip.style.display = 'block';

        const rect = container.getBoundingClientRect();
        const direction = (team === 'townsfolk') ? 'right' : 'left';
        const offsetX = direction === 'right'
          ? rect.right + 10
          : Math.max(10, rect.left - globalTooltip.offsetWidth - 10);
        const offsetY = rect.top + window.scrollY;

        globalTooltip.style.left = `${offsetX}px`;
        globalTooltip.style.top = `${offsetY}px`;
      });

      container.addEventListener('mouseleave', () => {
        globalTooltip.style.display = 'none';
      });

      return container;
    }

    async function loadRoles(scriptFileName) {
      try {
        const [customList, referenceList] = await Promise.all([
          fetch(`/Allscript/${scriptFileName}`).then(r => r.json()),
          fetch(`/EVERY_SINGLE_ROLE_with_chinese_abilities.json`).then(r => r.json())
        ]);

        const referenceMap = Object.fromEntries(referenceList.map(r => [r.id, r]));

        document.getElementById('townsfolkGrid').innerHTML = '';
        document.getElementById('outsiderGrid').innerHTML = '';
        document.getElementById('minionGrid').innerHTML = '';
        document.getElementById('demonGrid').innerHTML = '';

        customList.forEach(role => {
          const ref = referenceMap[role.id];
          if (!ref) return;

          const name = ref.name_zh || ref.name || role.id;
          const ability = ref.ability || '';
          const image = ref.image || '';

          const element = createRoleElement(name, ability, image, role.team);

          if (role.team === 'townsfolk') {
            document.getElementById('townsfolkGrid').appendChild(element);
          } else if (role.team === 'outsider') {
            document.getElementById('outsiderGrid').appendChild(element);
          } else if (role.team === 'minion') {
            document.getElementById('minionGrid').appendChild(element);
          } else if (role.team === 'demon') {
            document.getElementById('demonGrid').appendChild(element);
          }
        });
      } catch (err) {
        console.error('載入角色失敗', err);
      }
    }

    if (window.Twitch && window.Twitch.ext) {
      window.Twitch.ext.onAuthorized(auth => {
        window.Twitch.ext.configuration.onChanged(() => {
          try {
            const config = JSON.parse(window.Twitch.ext.configuration.broadcaster.content);
            if (config.selectedScript) {
              loadRoles(config.selectedScript);
            } else {
              loadRoles('custom-list.json');
            }
          } catch (e) {
            loadRoles('custom-list.json');
          }
        });
      });
    } else {
      loadRoles('custom-list.json');
    }
  </script>
</body>
</html>
