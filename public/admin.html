<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>BOTC Admin</title>
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: 'Microsoft JhengHei', sans-serif;
      padding: 20px;
    }
    label {
      font-size: 16px;
      margin-right: 10px;
    }
    select {
      padding: 5px 10px;
      font-size: 16px;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h2>選擇要顯示的劇本</h2>
  <label for="scriptSelect">劇本：</label>
  <select id="scriptSelect">
    <option>載入中...</option>
  </select>
  <div class="status" id="status"></div>

  <script>
    let twitch = window.Twitch ? window.Twitch.ext : null;
    let broadcasterID = '';

    async function loadScriptOptions() {
      try {
        const res = await fetch('/Allscript/scripts.json');
        const scripts = await res.json();
        const select = document.getElementById('scriptSelect');
        select.innerHTML = '';
        scripts.forEach(file => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file.replace('.json', '');
          select.appendChild(option);
        });
      } catch (err) {
        console.error('無法讀取劇本列表', err);
      }
    }

    function saveSelection(value) {
      if (twitch && broadcasterID) {
        twitch.configuration.set('broadcaster', '1.0', JSON.stringify({ selectedScript: value }));
        document.getElementById('status').textContent = `已儲存劇本：${value}`;
      }
    }

    if (twitch) {
      twitch.onAuthorized(auth => {
        broadcasterID = auth.userId;
        loadScriptOptions().then(() => {
          // 載入預設儲存值
          if (twitch.configuration.broadcaster) {
            try {
              const saved = JSON.parse(twitch.configuration.broadcaster.content);
              const select = document.getElementById('scriptSelect');
              if (saved.selectedScript) {
                select.value = saved.selectedScript;
              }
            } catch (e) {
              console.warn('無法解析儲存的 broadcaster config');
            }
          }
        });
      });
    }

    document.getElementById('scriptSelect').addEventListener('change', e => {
      saveSelection(e.target.value);
    });
  </script>
</body>
</html>
